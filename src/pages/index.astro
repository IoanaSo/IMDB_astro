---
import '../styles/global.css';
import { supabase } from '../lib/spClient';

// Obtener datos de la tabla "br1"
const { data: br, error } = await supabase
  .from('br1')
  .select('*')

if (error) {
  console.error('Error al obtener los datos de br1:', error.message)
}
---
<html lang="ca">
  <head>
    <meta charset="UTF-8" />
    <title>Cat√†leg IMDb</title>
  </head>
  <!--<body class="bg-gradient-to-br from-indigo-200 via-purple-200 to-pink-200 p-10 text-gray-900 font-sans">-->
   <body class="bg-gradient-to-r from-yellow-200 via-gray-200 to-grey-400 p-10 text-gray-900 font-sans">
    <!-- üîΩ Men√∫ principal -->
      <header class="mb-6">        <!--bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-300-->
        <nav class="flex flex-col md:flex-row md:justify-between items-center gap-4 bg-gradient-to-r from-black via-gray-300 to-yellow-300 p-10 text-gray-900 font-sans rounded-xl shadow-lg">
          <img src="/assets/imbd.jpg" alt="IMBD image" class="imbd"/>
          <div class="dropdown">
            <!-- <button class="dropdown-button" onclick="toggleDropdown()">Bases de dades</button>-->
            <button id="dropdownToggle" class="dropdown-button bg-purple-500 hover:bg-purple-600">Bases de dades</button>
            <div class="dropdown-content" id="dropdownMenu">
              <a href="/br">Basic i Ratings</a>
              <a href="/akas">Akas</a>
              <a href="/crew">Crew</a>
              <a href="/episode">Episode</a>
              <a href="/namebasics">Namebasics</a>
              <a href="/principals">Principals</a>
            </div>
          </div>

          
          <!-- üîÄ Selector de seccions -->
          <div class="flex gap-2 mt-1">
            <button id="showTop10" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Top 10</button>
            <button id="showExplorer" class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">Explora</button>
          </div>


          <!-- üîç Cercador -->
          <div class="cercador relative flex items-center">
            <label for="searchType" class="font-semibold text-purple-600">Cerca per:</label>
            <select id="searchType" class="rounded border-gray-800">
              <option value="titles">T√≠tols</option>
              <option value="actors">Actors</option>
            </select>
            <div class="relative">
              <input type="text" id="searchInput" placeholder="Escriu aqu√≠..." class="rounded p-1 border" />
              <button id="clearSearch" class="absolute right-1 top-1 text-gray-500 hover:text-red-500 hidden">‚úï</button>
              <ul id="resultsList" class="absolute z-10 mt-2 w-full bg-white border rounded shadow text-left text-sm text-gray-700 hidden"></ul>
            </div>
          </div>
        </nav>
      </header>
    
    <!-- üìå Modal de detalls -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-25 backdrop-blur- flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 w-[90%] max-w-xl shadow-xl text-gray-800 relative">
          <button id="closeModal" class="absolute top-3 right-4 text-gray-500 hover:text-black text-lg">‚úñ</button>
          <h2 id="modalTitle" class="text-2xl font-bold mb-3"></h2>
          <p id="modalInfo" class="text-sm mb-4"></p>
        
          <!-- üî¢ Valoraci√≥ -->
          <label class="block mb-2 font-medium">Valora aquesta obra:</label>
          <div id="ratingButtons" class="flex flex-wrap gap-2 mb-4">
            <!-- Els botons es generaran amb JavaScript -->
          </div>
          <button id="submitRating" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
            Enviar valoraci√≥
          </button>
      </div>
    </div>


    <!-- üé¨ Movies Carousel -->
    
    <section id="top10Section" class="relative mt-20 mb-10 p-6 bg-gradient-to-r from-black via-gray-300 to-yellow-300 rounded-xl shadow-lg">
      <h2 class="text-3xl font-extrabold text-white mb-4">Top 10 Pel¬∑l√≠cules</h2>

      <div id="carouselWrapper" class="overflow-hidden w-full mx-2 relative p-4">
      
        <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 z-20 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 z-20 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>


        <div id="moviesCarousel" class="flex transition-transform duration-500 ease-in-out z-100">
          <!-- targetes aqu√≠ -->
        </div>
      </div>
    </section>


    <!-- üì∫ Series Carousel -->
    <section id="seriesSection" class="relative mt-20 mb-10  p-6 bg-gradient-to-r from-black via-gray-300 to-yellow-300 rounded-xl shadow-lg">
      <h2 class="text-3xl font-extrabold text-white mb-4">Top 10 S√®ries</h2>
      <!-- <div id="seriesCarousel" class="flex overflow-x-auto space-x-4 scroll-smooth snap-x snap-mandatory p-3"></div>-->
        <div id="carouselWrapper" class="overflow-hidden w-full  mx-auto relative p-4">
        <button id="prevBtnS" class="absolute left-2 top-1/2 -translate-y-1/2 z-20 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        
        <button id="nextBtnS" class="absolute right-2 top-1/2 -translate-y-1/2 z-20 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition duration-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <div id="seriesCarousel" class="flex transition-transform duration-500 ease-in-out">
          <!-- targetes aqu√≠ -->
        </div>
      </div>
    </section>
    <!-- from-purple-300 via-pink-300 to-yellow-300  -->
    <section id="explorerSection" class="mt-20 mb-10 p-6 bg-gradient-to-r  from-black via-gray-300 to-yellow-300 rounded-xl shadow-lg">
      <h2 class="text-3xl font-extrabold text-white mb-6"> Explora pel¬∑l√≠cules i s√®ries</h2>

      <!-- Botones -->
      <div class="flex gap-4 mb-4">
        <button id="btnMovies" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Pel¬∑l√≠cules</button>
        <button id="btnSeries" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">S√®ries</button>
      </div>

      <!-- Filtres -->
      <div class="flex flex-wrap gap-4 mb-6">
        <select id="sortSelect" class="rounded p-2 border border-gray-800 text-black bg-white">
          <option value="rating">Ordena per valoraci√≥</option>
          <option value="az">Nom A-Z</option>
          <option value="za">Nom Z-A</option>
        </select>

        <select id="genreSelect" class="rounded p-2 border border-gray-800 text-black bg-white">
          <option value="">Tots els g√®neres</option>
          <option value="Action">Acci√≥</option>
          <option value="Comedy">Com√®dia</option>
          <option value="Drama">Drama</option>
          <option value="Horror">Terror</option>
          <option value="Romance">Rom√†ntic</option>
        </select>
      </div>

      <!-- Contingut -->
      <div id="mediaGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mx-auto"></div>
    </section>
    <script is:client type="module">
        import { supabase } from '../lib/spClient.js';
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = "https://uapfvdwbwfwhlwsqokbs.supabase.co";
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhcGZ2ZHdid2Z3aGx3c3Fva2JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzgyNTMsImV4cCI6MjA2ODc1NDI1M30.6MRmvrUNzP-sk-Msp7ckrEvRYh04vyeWIcQ5jI57Zpc";
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const testConnection = async () => {
    const { data, error } = await supabase
      .from('br1') // substitueix pel nom de la teva taula
      .select('*')
      .limit(1);

    if (error) {
      console.error('‚ùå Error de Supabase:', error.message);
    } else {
      console.log('‚úÖ Connexi√≥ correcta:', data);
    }
  };

  testConnection();

        const input = document.getElementById('searchInput');
        const resultsList = document.getElementById('resultsList');
        const searchType = document.getElementById('searchType');
        const moviesCarousel = document.getElementById('moviesCarousel');
        const seriesCarousel = document.getElementById('seriesCarousel');

      // üîç Cercador interactiu
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalInfo = document.getElementById('modalInfo');
        const closeModal = document.getElementById('closeModal');
        const submitRating = document.getElementById('submitRating');

        
        const clearSearch = document.getElementById('clearSearch');

        // Mostrar o amagar la "X" segons si hi ha text
        searchInput.addEventListener('input', () => {
          if (searchInput.value.trim() !== '') {
            clearSearch.classList.remove('hidden');
          } else {
            clearSearch.classList.add('hidden');
            resultsList.classList.add('hidden');
          }
        });

        // Esborrar el contingut i amagar resultats
        clearSearch.addEventListener('click', () => {
          searchInput.value = '';
          clearSearch.classList.add('hidden');
          resultsList.classList.add('hidden');
          searchInput.focus();
        });


        // üõë Tancar modal
        closeModal.addEventListener('click', () => {
        modal.classList.add('hidden');
        });
        
        document.addEventListener("DOMContentLoaded", () => {
          const toggle = document.getElementById("dropdownToggle");
          const menu = document.getElementById("dropdownMenu");

          toggle.addEventListener("click", (e) => {
            e.stopPropagation();
            menu.style.display = menu.style.display === "block" ? "none" : "block";
          });

          window.addEventListener("click", (e) => {
            if (!toggle.contains(e.target)) {
              menu.style.display = "none";
            }
          });
        });


        // üîÑ Cercador amb modal
        input.addEventListener('input', async () => {
        const query = input.value.trim().toLowerCase();
        const type = searchType.value;
        resultsList.innerHTML = '';
        if (!query) return;

        let table = type === 'actors' ? 'namebasics1' : 'br1';
        let field = type === 'actors' ? 'primaryName' : 'primaryTitle';

        const { data } = await supabase.from(table).select('*').ilike(field, `%${query}%`).limit(10);
        if (data && data.length > 0) {
          resultsList.classList.remove('hidden');
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'hover:bg-purple-100 p-2 rounded cursor-pointer transition';
            li.textContent = item[field];
            li.addEventListener('click', () => {
                // üßæ Mostrar informaci√≥
                modalTitle.textContent = item[field];
                modalInfo.innerHTML = `
                  <strong>Tipus:</strong> ${item.titleType ?? '‚Äî'}<br>
                  <strong>Any:</strong> ${item.startYear ?? '‚Äî'}<br>
                  <strong>G√®neres:</strong>  ${Array.isArray(item.genres) ? item.genres.join(', ') : item.genres.replace(/^\{|\}$/g, '') ?? '‚Äî'}<br>
                  <strong>Puntuaci√≥ mitjana:</strong> ${item.averageRating ?? '‚Äî'}<br>
                  <strong>Vots:</strong> ${item.numVotes ?? '‚Äî'}<br><br>
                  <a href="https://www.imdb.com/find?q=${encodeURIComponent(item[field])}" target="_blank" class="bg-gray-100 text-indigo-700 px-3 py-1 rounded inline-block mt-2 hover:bg-gray-200">
                    üîé Consulta a IMDb
                  </a>
                  `;

                  modal.classList.remove('hidden');

                    // ‚úçÔ∏è Enviar valoraci√≥

                  
                  const ratingButtonsContainer = document.getElementById('ratingButtons');
                  let selectedRating = null;

                  // üßπ Netejar botons anteriors
                  ratingButtonsContainer.innerHTML = '';

                  // Crear botons de 1 a 10
                  for (let i = 1; i <= 10; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = 'px-3 py-1 border rounded hover:bg-indigo-100';
                    btn.onclick = () => {
                      selectedRating = i;
                      // Ressaltar el bot√≥ seleccionat
                      document.querySelectorAll('#ratingButtons button').forEach(b => b.classList.remove('bg-indigo-300'));
                      btn.classList.add('bg-indigo-300');
                    };
                    ratingButtonsContainer.appendChild(btn);
                  }


                  document.getElementById('submitRating').onclick = () => {
                    if (selectedRating !== null) {
                      alert(`Has valorat l'obra amb un ${selectedRating}/10!`);
                      modal.classList.add('hidden');
                      // Aqu√≠ pots afegir m√©s accions, com tancar un modal o enviar la dada al servidor

                      // üî¢ Actualitzar numVotes i averageRating
                      item.numVotes = (item.numVotes ?? 0) + 1;
                      item.averageRating = (
                        ((item.averageRating ?? 0) * (item.numVotes - 1) + selectedRating) / item.numVotes
                      ).toFixed(1); // Arrodonir a 1 decimal

                      // üîÑ Actualitzar visualment la targeta (si cal)
                      const updatedStars = '‚òÖ'.repeat(Math.round(item.averageRating)) + '‚òÜ'.repeat(5 - Math.round(item.averageRating));
                      card.querySelector('p.text-yellow-500').textContent = updatedStars;
                      card.querySelector('p.text-gray-700').textContent = `${item.averageRating} / 10`;
                      card.querySelector('p.text-gray-500').textContent = `üó≥Ô∏è ${item.numVotes} vots`;

                      // üîÑ Actualitzar tamb√© el contingut del modal
                      modalInfo.innerHTML = `
                        <strong>Tipus:</strong> ${item.titleType ?? '‚Äî'}<br>
                        <strong>Any:</strong> ${item.startYear ?? '‚Äî'}<br>
                        <strong>G√®neres:</strong> ${Array.isArray(item.genres) ? item.genres.join(', ') : (item.genres?.replace(/^\{|\}$/g, '') ?? '‚Äî')}<br>
                        <strong>Puntuaci√≥ mitjana:</strong> ${item.averageRating}<br>
                        <strong>Vots:</strong> ${item.numVotes}<br><br>
                        <a href="https://www.imdb.com/find?q=${encodeURIComponent(item[field])}" target="_blank" class="bg-gray-100 text-indigo-700 px-3 py-1 rounded inline-block mt-2 hover:bg-gray-200">
                          üîé Consulta a IMDb
                        </a>
                        `;
                      modal.classList.add('hidden');
                    } else {
                      alert("Si us plau, selecciona una valoraci√≥ entre 0 i 10.");
                    }
                  };
                });

                resultsList.appendChild(li);
                });
            } else {
                resultsList.innerHTML = "<li>No s'han trobat resultats.</li>";
            };
            });
    </script>

  </body>
</html>
